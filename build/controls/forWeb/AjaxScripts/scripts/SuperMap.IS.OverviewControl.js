//================================================================================ 
// SuperMap IS .NET 客户端程序，版权所有，北京超图软件股份有限公司，2000-2008。 
// 本程序只能在有效的授权许可下使用。未经许可，不得以任何手段擅自使用或传播。 
// 作 者:  SuperMap IS Web Team 
// 版 本:  $Id: SuperMap.IS.OverviewControl.js,v 1.60 2010/08/26 07:18:10 zhangyt Exp $
// 文 件:  SuperMap.IS.OverviewControl.js 
// 描 述:  AjaxScripts 鹰眼控件 
// 更 新:  $Date: 2010/08/26 07:18:10 $ 
//================================================================================
SuperMap.IS.OverviewControl=function(z,Q,E){if(!Q||!z){return }var y=Q;var I=null;var AI=null;var x="";var v=new Array();var h=new Array();var K=null;var e="";var t=null;z=_GetDomElement(z);var F=z.clientWidth;var g=z.clientHeight;var O=0,T=0;var i=2;var f=0,S=0;var C=0,AD=0;var N=0,L=0;var W=0,U=0;var o;var c=false;var AN=false;var D=false;var P=false;var M;var AB="none";var AL=0,AJ=0;var a=5;var AG="red";var B="solid";var Z="2px";var p=null,q=null;y.AttachEvent("oninit",m);this.url;this.viewBounds;this.mapName;this.Destroy=V;this.AttachEvent=l;this.DetachEvent=r;var Y=this;this.Show=function(){z.style.visibility="visible";K.style.visibility="visible"};this.Hide=function(){z.style.visibility="hidden";K.style.visibility="hidden"};function m(){AH();console.log("_OnMapInit")}function s(){console.log("_OnMapChangeView");if(D){D=false;return }if(!P){N=parseInt(K.style.left);L=parseInt(K.style.top)}AI=y.GetViewBounds();console.log("_indexBounds:"+AI.ToString());d();AM(true);P=false}function u(){console.log("_OnMapSwitchMap");e="";I=null;E=null;n()}function A(){console.log("_OnMapDestroy");V()}function AH(){if(c||AN){return }c=true;if(E){if(E.indexBoxBorderColor){AG=E.indexBoxBorderColor}if(E.indexBoxBorderStyle){B=E.indexBoxBorderStyle}if(E.indexBoxBorderWidth){Z=E.indexBoxBorderWidth}if(E.mapName){e=E.mapName}if(E.viewBounds){I=E.viewBounds}if(E.overviewUrl){Y.url=E.overviewUrl}}if(t&&t.parentNode){t.parentNode.removeChild(t)}if(!t){t=document.createElement("div")}var AO=null;AO=t.style;AO.width=F+"px";AO.height=g+"px";AO.position="relative";AO.overflow="hidden";z.appendChild(t);if(K&&K.parentNode){K.parentNode.removeChild(K)}if(!K){K=document.createElement("div")}K.id=z.id+"_IndexBox";AO=K.style;AO.borderColor=AG;AO.borderStyle=B;AO.borderWidth=Z;AO.position="absolute";AO.visibility="visible";AO.zIndex=1;AO.fontSize="1px";AO.width=C+"px";AO.height=AD+"px";AO.left=f+"px";AO.top=S+"px";AO=null;t.appendChild(K);y.AttachEvent("onstartswitchmap",AF);y.AttachEvent("onchangeview",s);y.AttachEvent("onendswitchmap",u);y.AttachEvent("ondestroying",A);z.attachEvent("onmousedown",J);z.attachEvent("onmousemove",X);z.attachEvent("onmouseup",G);z.attachEvent("onmouseover",w);z.attachEvent("onmousewheel",R);n();AN=true}function AF(){D=true}function V(){y.DetachEvent("oninit",m);y.DetachEvent("onstartswitchmap",AF);y.DetachEvent("onchangeview",s);y.DetachEvent("onendswitchmap",u);y.DetachEvent("ondestroying",A);y=null;if(K&&K.parentNode){K.parentNode.removeChild(K)}K=null;if(t&&t.parentNode){t.parentNode.removeChild(t)}t=null;I=null;AI=null;z.detachEvent("onmousedown",J);z.detachEvent("onmousemove",X);z.detachEvent("onmouseup",G);z.detachEvent("onmouseover",w);z.detachEvent("onmousewheel",R);z=E=null}function n(){if(!e){e=Y.mapName?Y.mapName:y.mapName}if(!I){I=y.GetMapBounds()}console.log("_viewBounds:"+I.ToString());AI=y.GetViewBounds();console.log("_indexBounds:"+AI.ToString());d();AM(true);H()}function H(){if(!Y.url){var AR=new SuperMap.IS.Overview();AR.mapName=e;AR.viewer=new SuperMap.IS.PixelRect(0,0,F,g);AR.viewBounds=I;var AQ=y.mapNames;var AO=false;for(var AP=0;AP<AQ.length;AP++){if(AQ[AP]==AR.mapName){AO=true;break}}if(AO){y.GetOverview(AR,AA,AK,"_SwitchMap")}else{alert("The map corresponding wiht the overview doesn't exist.")}}else{this.viewBounds=I;t.style.backgroundImage="url("+Y.url+")";t.style.backgroundRepeat="no-repeat"}}function l(AQ,AR){var AP=v[AQ];if(!AP){AP=new Array();v[AQ]=AP;h.push(AQ)}for(var AO=0;AO<AP.length;AO++){if(AP[AO]==AR){return true}}AP.push(AR)}function r(AQ,AR){var AP=v[AQ];if(!AP){return }for(var AO=0;AO<AP.length;AO++){if(AP[AO]==AR){AP.splice(AO,1)}}}function b(AR,AS,AT){var AQ=v[AR];if(!AQ){return }if(!AS){AS=k()}var AO=AQ.concat();for(var AP=0;AP<AO.length;AP++){if(AO[AP]){AO[AP](AS,AT)}}while(AO.length>0){AO.pop()}}function k(){var AS=parseInt(K.style.left)-parseInt(N);var AR=parseInt(K.style.top)-parseInt(L);var AP=y.GetSize();var AO=AP.Width()/K.realWidth;var AT=AP.Height()/K.realHeight;AS=AS*AO;AR=AR*AT;var AQ=new Object();AQ.offsetX=AS;AQ.offsetY=AS;return AQ}this.TriggerServerEvent=function(AO,AP){eval(z.id+"_doPostBack(container.id, eventName+'|'+e.offsetX+','+e.offsetY)")};function AM(AP){var AR=K.style;AR.width=C+"px";AR.height=AD+"px";AR.left=f+"px";AR.top=S+"px";AR=null;K.parentNode.removeChild(K);t.appendChild(K);if(!P&&AP){W=parseInt(K.style.left)-parseInt(N);U=parseInt(K.style.top)-parseInt(L);if(W==0||U==0){return }var AQ=y.GetSize();var AO=AQ.Width()/K.realWidth;var AS=AQ.Height()/K.realHeight;W=W*AO;U=U*AS;P=true;b("indexboxChanged",{offsetX:W,offsetY:W},"IndexboxChanged")}AE()}function AE(){var AQ=new Object();AQ.viewBounds=I;AQ.indexBounds=AI;var AO=_ToJSON(AQ);var AP=document.getElementById(z.id+"_hiddenProperty");if(AP){AP.value=AO}}function d(){var AR=(AI.leftBottom.x-I.leftBottom.x)/(I.rightTop.x-I.leftBottom.x);f=F*AR;var AQ=(I.rightTop.y-AI.rightTop.y)/(I.rightTop.y-I.leftBottom.y);S=g*AQ;var AP=(AI.rightTop.x-AI.leftBottom.x)/(I.rightTop.x-I.leftBottom.x);C=F*AP;K.realWidth=C;var AO=(AI.rightTop.y-AI.leftBottom.y)/(I.rightTop.y-I.leftBottom.y);AD=g*AO;K.realHeight=AD;if(I.leftBottom.x<=Q.GetMapBounds().leftBottom.x||I.leftBottom.y<=Q.GetMapBounds().leftBottom.y||I.rightTop.x>=Q.GetMapBounds().rightTop.x||I.rightTop.y>=Q.GetMapBounds().rightTop.y){if(f<0){C=C+f;f=0}if(f+C>F-2*i){C=F-2*i-f}if(S<0){AD=AD+S;S=0}if(S+AD>g-2*i){AD=g-2*i-S}if(C<5){C=5}if(AD<5){AD=5}if(C>F){C=F}if(AD>g){AD=g}}}function w(AQ){if(C>a&&AD>a){AQ=_GetEvent(AQ);var AP=_GetMouseX(AQ);var AO=_GetMouseY(AQ);AC(AP,AO)}}function J(AV){o=true;_CancelBubble(AV);N=f;L=S;AL=K.realWidth;AJ=K.realHeight;O=_GetElementX(z);T=_GetElementY(z);AV=_GetEvent(AV);var AS=_GetMouseX(AV);var AQ=_GetMouseY(AV);if(C>a&&AD>a){var AO="default";var AU=O+N;var AR=T+L;var AP=AU+C;var AT=AR+AD;if(AS>=AU-a&&AS<=AU+a&&AQ>=AR-a&&AQ<=AR+a){AO="nwse";AB="lt";N=N+AL;L=L+AJ}if(AS>=AU-a&&AS<=AU+a&&AQ>=AT-a&&AQ<=AT+a){AO="nesw";AB="lb";N=N+AL}if(AS>=AP-a&&AS<=AP+a&&AQ>=AT-a&&AQ<=AT+a){AO="nwse";AB="rb"}if(AS>=AP-a&&AS<=AP+a&&AQ>=AR-a&&AQ<=AR+a){AO="nesw";AB="rt";L=L+AJ}if(AO!="default"){if(_ygPos.browser=="ie"){z.style.cursor=_scriptLocation+"../images/cur_aero_"+AO+".cur"}else{if(_ygPos.browser=="ie8"){z.style.cursor="url(images/cur_aero_"+AO+".cur),auto"}else{z.style.cursor=AO.slice(0,2)+"-resize"}}}else{if(_ygPos.browser=="ie"){z.style.cursor=""}else{z.style.cursor="default"}}}if(AB=="none"){f=AS-O-C/2;S=AQ-T-AD/2;AM(false)}}function X(AR){AR=_GetEvent(AR);_CancelBubble(AR);var AQ=_GetMouseX(AR);var AP=_GetMouseY(AR);if(!o){AC(AQ,AP);return }O=_GetElementX(t);T=_GetElementY(t);if(AB=="lt"||AB=="lb"||AB=="rb"||AB=="rt"){var AS=AL/AJ;var AO=AQ-N;var AT=AP-L;C=Math.abs(AO-O);AD=Math.abs(AT-T);if(AO<O){f=N-C}else{f=N}if(AT<T){S=L-AD}else{S=L}AC(AQ,AP);AM(false);return }else{if(_ygPos.browser=="ie"){z.style.cursor=""}else{z.style.cursor="default"}f=AQ-O-C/2;S=AP-T-AD/2;AM(false);return false}}function G(Ad){if(!o){return }o=false;Ad=_GetEvent(Ad);_CancelBubble(Ad);var AU=y.GetSize();var AQ=AU.Width()/K.realWidth;var AO=AU.Height()/K.realHeight;var AX=y.GetMapCenterX();var AV=y.GetMapCenterY();var Aa=y.GetMapScale();if(AB=="lt"||AB=="lb"||AB=="rb"||AB=="rt"){var AY=_GetMouseX(Ad);var AW=_GetMouseY(Ad);AC(AY,AW);var Ag=C/AL;W=C-AL;U=AD-AJ;W=W*AQ;U=U*AO;var AT=0;var Ae=0;var AR=1;var AP=1;var AS=1;var AZ=1;var Ac=y.PixelToMapDistance(W,Aa);var Ab=y.PixelToMapDistance(-U,Aa);if(f<N){if(AB=="rb"||AB=="rt"){Ae=y.PixelToMapDistance(AL*AQ,Aa);AS=-1}AR=-1}else{if(AB=="lt"||AB=="lb"){Ae=y.PixelToMapDistance(AL*AQ,Aa)}}if(S<L){if(AB=="rb"||AB=="lb"){AT=y.PixelToMapDistance(AJ*AO,Aa)}AP=-1}else{if(AB=="lt"||AB=="rt"){AT=y.PixelToMapDistance(AJ*AO,Aa);AZ=-1}}var Af=new SuperMap.IS.MapCoord(AX+Ae*AS+Ac/2*AR,AV+AT*AZ+Ab/2*AP);if(y.customBounds!=null){if(!j(Af,y.customBounds,Aa/Ag)){s();return }}y.SetCenterAndZoom(AX+Ae*AS+Ac/2*AR,AV+AT*AZ+Ab/2*AP,Aa/Ag);AB="none"}else{W=f-N;U=S-L;W=W*AQ;U=U*AO;var Ac=y.PixelToMapDistance(W,Aa);var Ab=y.PixelToMapDistance(-U,Aa);var Af=new SuperMap.IS.MapCoord(AX+Ac,AV+Ab);if(y.customBounds!=null){if(!j(Af,y.customBounds,Aa)){s();return }}y.SetCenterAndZoom(AX+Ac,AV+Ab)}AM(true);W=0;U=0;return false}function R(AO){AO=_GetEvent(AO);_CancelBubble(AO);if(AO.detail){if(AO.detail>0){y.ZoomOut()}else{y.ZoomIn()}}else{if(AO.wheelDelta>0){y.ZoomIn()}else{y.ZoomOut()}}if(AO.preventDefault){AO.preventDefault()}return false}function AA(AO,AP){if(!Y.url){this.url=AO.url}else{this.url=Y.url}this.viewBounds=AO.viewBounds;t.style.backgroundImage="url("+this.url+")";t.style.backgroundRepeat="no-repeat";if(!I||!I.Equals(AO.viewBounds)){console.log("_viewBoundsChanged:"+I.ToString());I=AO.viewBounds;s()}console.log("_viewBounds:"+I.ToString())}function AK(AO){if(AO){alert(SuperMap.IS.OverivewControlResource.getOverivewError+":"+AO)}else{alert(SuperMap.IS.OverivewControlResource.getOverivewError+"!")}}this.Update=function(){if(this.viewBounds){I=this.viewBounds}else{if(E&&E.viewBounds){I=E.viewBounds}else{I=y.GetMapBounds()}}if(this.mapName){e=this.mapName}else{if(E&&E.mapName){e=E.mapName}else{e=y.mapName}}H()};function AC(AR,AQ){var AO="default";O=_GetElementX(z);T=_GetElementY(z);var AU=O+f;var AS=T+S;var AP=AU+C;var AT=AS+AD;if((AR>=AU-a&&AR<=AU+a&&AQ>=AS-a&&AQ<=AS+a)||(AR>=AP-a&&AR<=AP+a&&AQ>=AT-a&&AQ<=AT+a)){AO="nwse"}else{if((AR>=AU-a&&AR<=AU+a&&AQ>=AT-a&&AQ<=AT+a)||(AR>=AP-a&&AR<=AP+a&&AQ>=AS-a&&AQ<=AS+a)){AO="nesw"}}if(AO!="default"){if(_ygPos.browser=="ie"){z.style.cursor=_scriptLocation+"../images/cur_aero_"+AO+".cur"}else{if(_ygPos.browser=="ie8"){z.style.cursor="url(images/cur_aero_"+AO+".cur),auto"}else{z.style.cursor=AO.slice(0,2)+"-resize"}}}else{if(_ygPos.browser=="ie"){z.style.cursor=""}else{z.style.cursor="default"}}}function j(AT,AO,AW){var AS=0;var AU=0;var AQ=0;var AP=0;var AV=0;var AR=0;var AX=true;if(AW!=null){AS=Q.PixelToMapDistance(Q.container.style.pixelHeight,AW);AU=Q.PixelToMapDistance(Q.container.style.pixelWidth,AW)}AQ=AO.rightTop.x-AU/2;AP=AO.rightTop.y-AS/2;AV=AU/2+AO.leftBottom.x;AR=AS/2+AO.leftBottom.y;if(AT.x<AV){AX=false}if(AT.y<AR){AX=false}if(AT.x>AQ){AX=false}if(AT.y>AP){AX=false}return AX}}
